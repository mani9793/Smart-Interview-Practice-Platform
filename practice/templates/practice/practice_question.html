{% extends 'base.html' %}
{% block title %}Question {{ question_number }} – Practice{% endblock %}
{% block content %}
<div class="card card-sip shadow-sm p-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <p class="text-muted-sip small mb-0">
            Question {{ question_number }} of {{ total_questions }} · <span class="badge {% if question.difficulty == 'easy' %}badge-easy{% elif question.difficulty == 'hard' %}badge-hard{% else %}badge-medium{% endif %} rounded-pill">{{ question.get_difficulty_display }}</span> · {{ session.question_set.name }}
        </p>
        {% if timer_enabled %}
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <span class="d-inline-flex align-items-center gap-1">
                <i class="bi bi-stopwatch text-primary" style="font-size: 1.25rem;" aria-hidden="true"></i>
                <span class="badge bg-secondary rounded-pill" id="session-timer-display">0:00</span>
            </span>
            <a href="{% url 'practice:practice_session' session_id %}?action=end_timer" class="btn btn-outline-danger btn-sm" onclick="return confirm('End session now? You can review your answers on the next page.');">End session</a>
        </div>
        {% endif %}
    </div>
    <h2 class="h5 fw-semibold mb-3">Question</h2>
    <div class="bg-sip-subtle rounded p-3 mb-4 text-break">{{ question.text|linebreaksbr }}</div>
    {% if question.tags %}<p class="text-muted-sip small mb-3">Tags: {{ question.tags }}</p>{% endif %}
    <form method="post" action="">
        {% csrf_token %}
        <div class="mb-4">
            <label for="id_response_text" class="form-label fw-medium">Your answer</label>
            <textarea name="response_text" id="id_response_text" rows="8" class="form-control" placeholder="Type your answer here...">{% if form.response_text.value %}{{ form.response_text.value }}{% endif %}</textarea>
            {% if form.response_text.errors %}<div class="form-text text-danger">{{ form.response_text.errors }}</div>{% endif %}
        </div>
        <div class="mb-4 self-rating-block">
            <span class="form-label fw-medium d-block mb-2">Self-rating (optional)</span>
            <div class="star-rating" id="starRatingContainer" data-rating="0" role="group" aria-label="Rate your answer 1 to 5 stars">
                <input type="radio" name="self_rating" value="1" id="id_self_rating_1" class="visually-hidden">
                <input type="radio" name="self_rating" value="2" id="id_self_rating_2" class="visually-hidden">
                <input type="radio" name="self_rating" value="3" id="id_self_rating_3" class="visually-hidden">
                <input type="radio" name="self_rating" value="4" id="id_self_rating_4" class="visually-hidden">
                <input type="radio" name="self_rating" value="5" id="id_self_rating_5" class="visually-hidden">
                <div class="star-labels">
                    <label for="id_self_rating_1" class="star-label">★</label>
                    <label for="id_self_rating_2" class="star-label">★</label>
                    <label for="id_self_rating_3" class="star-label">★</label>
                    <label for="id_self_rating_4" class="star-label">★</label>
                    <label for="id_self_rating_5" class="star-label">★</label>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-sip-primary">
            <i class="bi bi-check-lg me-1"></i>Save &amp; Next
        </button>
    </form>
</div>
{% block extra_css %}
<style>
.star-rating .star-labels { display: flex; gap: 0.25rem; align-items: center; }
.star-rating .star-label {
    cursor: pointer;
    color: #b0b0b0;
    font-size: 1.9rem;
    line-height: 1;
    transition: color 0.15s ease;
    user-select: none;
}
.star-rating .star-label:hover { color: #e6c200; }
.star-rating[data-rating="1"] .star-label:nth-child(1) { color: #e6b800; }
.star-rating[data-rating="2"] .star-label:nth-child(1),
.star-rating[data-rating="2"] .star-label:nth-child(2) { color: #e6b800; }
.star-rating[data-rating="3"] .star-label:nth-child(1),
.star-rating[data-rating="3"] .star-label:nth-child(2),
.star-rating[data-rating="3"] .star-label:nth-child(3) { color: #e6b800; }
.star-rating[data-rating="4"] .star-label:nth-child(1),
.star-rating[data-rating="4"] .star-label:nth-child(2),
.star-rating[data-rating="4"] .star-label:nth-child(3),
.star-rating[data-rating="4"] .star-label:nth-child(4) { color: #e6b800; }
.star-rating[data-rating="5"] .star-label:nth-child(1),
.star-rating[data-rating="5"] .star-label:nth-child(2),
.star-rating[data-rating="5"] .star-label:nth-child(3),
.star-rating[data-rating="5"] .star-label:nth-child(4),
.star-rating[data-rating="5"] .star-label:nth-child(5) { color: #e6b800; }
</style>
{% endblock %}
{% block extra_js %}
<script>
(function() {
    var container = document.getElementById('starRatingContainer');
    if (!container) return;
    var radios = container.querySelectorAll('input[type="radio"]');
    function setRating() {
        var val = 0;
        for (var i = 0; i < radios.length; i++) {
            if (radios[i].checked) { val = radios[i].value; break; }
        }
        container.setAttribute('data-rating', val);
    }
    for (var i = 0; i < radios.length; i++) {
        radios[i].addEventListener('change', setRating);
    }
    setRating();
})();
</script>
{% if timer_enabled %}
<script>
(function() {
    var el = document.getElementById('session-timer-display');
    if (!el) return;
    var startMs = {{ session_start_timestamp_ms }};
    var totalPausedSec = {{ total_paused_seconds }};
    var pausedAtMs = {% if paused_at_timestamp_ms %}{{ paused_at_timestamp_ms }}{% else %}null{% endif %};
    var isPaused = {{ timer_paused|yesno:"true,false" }};
    function pad(n) { return n < 10 ? '0' + n : n; }
    function formatElapsed(secs) {
        var m = Math.floor(secs / 60);
        var s = secs % 60;
        return m + ':' + pad(s);
    }
    function getElapsedSeconds() {
        if (isPaused && pausedAtMs !== null) {
            return Math.max(0, Math.floor((pausedAtMs - startMs) / 1000) - totalPausedSec);
        }
        return Math.max(0, Math.floor((Date.now() - startMs) / 1000) - totalPausedSec);
    }
    function tick() {
        el.textContent = formatElapsed(getElapsedSeconds());
        setTimeout(tick, 1000);
    }
    tick();
})();
</script>
{% endif %}
{% endblock %}
{% endblock %}
